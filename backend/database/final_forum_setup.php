<?php
// Final forum database setup without foreign key constraints

$host = 'localhost';
$username = 'root';
$password = '';
$database = 'zh_love_db';

try {
    $pdo = new PDO("mysql:host=$host;dbname=$database;charset=utf8mb4", $username, $password);
    $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
    
    echo "Connected to database successfully.\n";
    
    // Drop existing forum tables if they exist
    $dropTables = [
        'DROP TABLE IF EXISTS forum_likes',
        'DROP TABLE IF EXISTS forum_comments', 
        'DROP TABLE IF EXISTS forum_posts',
        'DROP TABLE IF EXISTS forum_categories'
    ];
    
    foreach ($dropTables as $sql) {
        $pdo->exec($sql);
        echo "Executed: $sql\n";
    }
    
    // Create forum_categories table
    $createCategories = "
    CREATE TABLE forum_categories (
        id INT AUTO_INCREMENT PRIMARY KEY,
        name VARCHAR(255) NOT NULL,
        description TEXT,
        icon VARCHAR(50),
        color VARCHAR(7) DEFAULT '#4F9CF9',
        topic_count INT DEFAULT 0,
        comment_count INT DEFAULT 0,
        last_post_title VARCHAR(255),
        last_post_author VARCHAR(255),
        last_post_date TIMESTAMP NULL,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
    )";
    
    $pdo->exec($createCategories);
    echo "Created forum_categories table\n";
    
    // Create forum_posts table (without foreign key constraints)
    $createPosts = "
    CREATE TABLE forum_posts (
        id INT AUTO_INCREMENT PRIMARY KEY,
        title VARCHAR(255) NOT NULL,
        content TEXT NOT NULL,
        author_id INT DEFAULT 1,
        author_username VARCHAR(255) DEFAULT 'ูุฌููู',
        category_id INT DEFAULT 1,
        category_name VARCHAR(255) DEFAULT 'ุนุงู',
        category_color VARCHAR(7) DEFAULT '#4F9CF9',
        view_count INT DEFAULT 0,
        like_count INT DEFAULT 0,
        comment_count INT DEFAULT 0,
        is_pinned BOOLEAN DEFAULT FALSE,
        is_featured BOOLEAN DEFAULT FALSE,
        status ENUM('published', 'draft', 'archived') DEFAULT 'published',
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
    )";
    
    $pdo->exec($createPosts);
    echo "Created forum_posts table\n";
    
    // Create forum_comments table (without foreign key constraints)
    $createComments = "
    CREATE TABLE forum_comments (
        id INT AUTO_INCREMENT PRIMARY KEY,
        post_id INT NOT NULL,
        content TEXT NOT NULL,
        author_id INT DEFAULT 1,
        author_username VARCHAR(255) DEFAULT 'ูุฌููู',
        like_count INT DEFAULT 0,
        parent_id INT NULL,
        status ENUM('published', 'hidden') DEFAULT 'published',
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
    )";
    
    $pdo->exec($createComments);
    echo "Created forum_comments table\n";
    
    // Create forum_likes table (without foreign key constraints)
    $createLikes = "
    CREATE TABLE forum_likes (
        id INT AUTO_INCREMENT PRIMARY KEY,
        user_id INT NOT NULL,
        post_id INT NULL,
        comment_id INT NULL,
        type ENUM('post', 'comment') NOT NULL,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        UNIQUE KEY unique_like (user_id, post_id, comment_id, type)
    )";
    
    $pdo->exec($createLikes);
    echo "Created forum_likes table\n";
    
    // Insert sample categories
    $categories = [
        ['ุงูููุงุดุงุช ุงูุนุงูุฉ', 'ููุงุดุงุช ุนุงูุฉ ุญูู ุงููุนุจุฉ ูุงููุฌุชูุน', '๐ฌ', '#4F9CF9'],
        ['ุงูุงุณุชุฑุงุชูุฌูุงุช ูุงูุชูุชููุงุช', 'ุดุงุฑู ุงุณุชุฑุงุชูุฌูุงุชู ูุชุนูู ูู ุงูุฎุจุฑุงุก', '๐ฏ', '#06D6A0'],
        ['ุงูุจุทููุงุช ูุงูุชุญุฏูุงุช', 'ุฃุฎุจุงุฑ ุงูุจุทููุงุช ูุงูููุงูุณุงุช', '๐', '#FFD166'],
        ['ุงูููุฏุฒ ูุงูุฎุฑุงุฆุท', 'ุชุญููู ููุดุงุฑูุฉ ุงูููุฏุฒ ูุงูุฎุฑุงุฆุท', '๐บ๏ธ', '#F72585'],
        ['ุงูุฏุนู ุงูุชููู', 'ูุณุงุนุฏุฉ ูู ุญู ุงููุดุงูู ุงูุชูููุฉ', '๐ง', '#FF6B6B'],
        ['ุงูุนุดุงุฆุฑ ูุงููุฑู', 'ุชูุณูู ุงูุนุดุงุฆุฑ ูุงูุงูุถูุงู ูููุฑู', '๐ฅ', '#9B59B6']
    ];
    
    $insertCat = $pdo->prepare("
        INSERT INTO forum_categories (name, description, icon, color, topic_count, comment_count) 
        VALUES (?, ?, ?, ?, ?, ?)
    ");
    
    foreach ($categories as $cat) {
        $topicCount = rand(15, 95);
        $commentCount = rand(100, 600);
        $insertCat->execute([$cat[0], $cat[1], $cat[2], $cat[3], $topicCount, $commentCount]);
    }
    echo "Inserted sample categories\n";
    
    // Insert sample posts
    $posts = [
        [
            'ุงูุฏููู ุงูุดุงูู ููุนุจ ูุน ุงูููุงูุงุช ุงููุชุญุฏุฉ ูู 2024',
            'ุฏููู ูุชูุงูู ูุบุทู ุฌููุน ุงุณุชุฑุงุชูุฌูุงุช ุงูููุงูุงุช ุงููุชุญุฏุฉ ูุน ุฃุญุฏุซ ุงูุชุญุฏูุซุงุช ูุงูุชูุชููุงุช ุงููุชูุฏูุฉ ูููุตูู ูุฃุนูู ุงููุณุชููุงุช ุงูุชูุงูุณูุฉ. ุณูุชุญุฏุซ ุนู ุจูุงุก ุงููุงุนุฏุฉุ ุงุฎุชูุงุฑ ุงูุฌูุฑุงูุงุชุ ุงูุชูุชููุงุช ุงููุฎุชููุฉ ูู ูู ูุฑุญูุฉ ูู ูุฑุงุญู ุงููุนุจ.\n\nุณูุบุทู ุงูููุงุถูุน ุงูุชุงููุฉ:\n1. ุฅุนุฏุงุฏ ุงููุงุนุฏุฉ ุงูุฃูุซู\n2. ุชุฑุชูุจุงุช ุงููุญุฏุงุช ุงููุฌูููุฉ\n3. ุงูุฏูุงุน ุถุฏ ุงููุฌูุงุช ุงูุฌููุฉ\n4. ุชูุชููุงุช ุงูุญุฑุจ ุงูุงูุชุตุงุฏูุฉ\n\nูุฐุง ุงูุฏููู ููุงุณุจ ููุงุนุจูู ูู ุงููุณุชูู ุงููุชูุณุท ุฅูู ุงููุชูุฏู.',
            1, 'ุณูุฏ ุฃูุฑููุง', 2, 'ุงูุงุณุชุฑุงุชูุฌูุงุช ูุงูุชูุชููุงุช', '#06D6A0', 1250, 45, 23, 1, 1
        ],
        [
            'ุจุทููุฉ ุงูุดุฑู ุงูุฃูุณุท ุงููุจุฑู - ุฌูุงุฆุฒ 5000$ ๐ฐ',
            'ุฅุนูุงู ุฑุณูู ุนู ุจุทููุฉ ุงูุดุฑู ุงูุฃูุณุท ุงููุจุฑู 2024 ูุน ุฌูุงุฆุฒ ุชุตู ุฅูู 5000 ุฏููุงุฑ ูุงูุชุณุฌูู ููุชูุญ ุงูุขู ูุฌููุน ุงููุงุนุจูู ูู ุงูููุทูุฉ. ุงูุจุทููุฉ ุณุชููู ุนูู ูุฏุงุฑ ุดูุฑ ูุงูู ูุน ูุจุงุฑูุงุช ููููุฉ.\n\nุชูุงุตูู ุงูุจุทููุฉ:\n- ุชุงุฑูุฎ ุงูุจุฏุก: 1 ูุงุฑุณ 2024\n- ุงููุฏุฉ: ุดูุฑ ูุงูู\n- ุนุฏุฏ ุงููุดุงุฑููู: 256 ูุงุนุจ\n- ูุธุงู ุงูุฅูุตุงุก: ูุฑุญูุฉ ูุงุญุฏุฉ\n\nุงูุชุณุฌูู ูุฌุงูู ูุงููุดุงุฑูุฉ ููุชูุญุฉ ููุฌููุน!',
            1, 'ุฅุฏุงุฑุฉ ุงูุจุทููุงุช', 3, 'ุงูุจุทููุงุช ูุงูุชุญุฏูุงุช', '#FFD166', 890, 67, 34, 1, 1
        ],
        [
            'ุฃูุถู ุงูุฎุฑุงุฆุท ููุนุจ ุงูุฌูุงุนู 2024',
            'ูุฌููุนุฉ ููุชูุงุฉ ูู ุฃูุถู ุงูุฎุฑุงุฆุท ููุนุจ ุงูุฌูุงุนู ูุน ุงูุฃุตุฏูุงุกุ ุชู ุงุฎุชุจุงุฑูุง ูุชูููููุง ูู ูุจู ุงููุฌุชูุน. ุชุดูู ุฎุฑุงุฆุท ููุงุณูููุฉ ููุนุฏูุฉ ุฌุฏูุฏุฉ.\n\nูุงุฆูุฉ ุงูุฎุฑุงุฆุท ุงููุฑุดุญุฉ:\n1. Desert Storm Enhanced\n2. Urban Warfare 2024\n3. Mountain Strike\n4. Coastal Defense\n5. Industrial Complex\n\nูู ุฎุฑูุทุฉ ุชุฃุชู ูุน ูุตู ููุตู ูุฅุฑุดุงุฏุงุช ุงููุนุจ.',
            1, 'ูุญุจู ุงูุฎุฑุงุฆุท', 4, 'ุงูููุฏุฒ ูุงูุฎุฑุงุฆุท', '#F72585', 456, 32, 18, 0, 1
        ],
        [
            'ุญู ูุดููุฉ ุชููู ุงููุนุจุฉ ูู ูููุฏูุฒ 11',
            'ุฏููู ุดุงูู ูุญู ุฌููุน ูุดุงูู ุงูุชูุงูู ูุน ูููุฏูุฒ 11 ูุทุฑู ุชุดุบูู ุงููุนุจุฉ ุจุฏูู ูุดุงูู. ูุชุถูู ุฅุนุฏุงุฏุงุช ุงูุชูุงูู ูุงูุจุงุชุดุงุช ุงููุทููุจุฉ.\n\nุงูุฎุทูุงุช:\n1. ุชุญููู ุจุงุชุด ุงูุชูุงูู\n2. ุชุบููุฑ ุฅุนุฏุงุฏุงุช ุงูุชูุงูู\n3. ุชุดุบูู ุงููุนุจุฉ ููุฏูุฑ\n4. ุชุนุฏูู ุฅุนุฏุงุฏุงุช ุงูุฑุณูููุงุช\n\nุงูุญู ูุถููู 100% ูููุดููุฉ.',
            1, 'ุงูุฎุจูุฑ ุงูุชููู', 5, 'ุงูุฏุนู ุงูุชููู', '#FF6B6B', 678, 28, 15, 0, 0
        ],
        [
            'ุชุดููู ูุฑูู ุฌุฏูุฏ ููุจุทููุงุช - ุงุจุญุซ ุนู ุฃุนุถุงุก',
            'ุฃุจุญุซ ุนู ูุงุนุจูู ูุญุชุฑููู ููุงูุถูุงู ููุฑูู ุฌุฏูุฏ ุณูุดุงุฑู ูู ุงูุจุทููุงุช ุงูุฏูููุฉ. ุงููุทููุจ ุฎุจุฑุฉ ูุง ุชูู ุนู 3 ุณููุงุช ููุณุชูู ุนุงูู.\n\nุงููุชุทูุจุงุช:\n- ุฎุจุฑุฉ ูุง ุชูู ุนู 3 ุณููุงุช\n- ูุณุชูู ุชูุงูุณู ุนุงูู\n- ุงููุฏุฑุฉ ุนูู ุงููุนุจ ูู ุฃููุงุช ูุญุฏุฏุฉ\n- ุงูุชูุงุตู ุนุจุฑ Discord\n\nููุชูุงุตู: Discord ุฃู ุฑุณุงูุฉ ุฎุงุตุฉ',
            1, 'ูุงุฆุฏ ุงููุฑูู', 6, 'ุงูุนุดุงุฆุฑ ูุงููุฑู', '#9B59B6', 234, 19, 12, 0, 0
        ],
        [
            'ูุตุงุฆุญ ูููุจุชุฏุฆูู ูู ุนุงูู ุงูุฌูุฑุงูุงุช',
            'ูุฌููุนุฉ ูุตุงุฆุญ ูููุฉ ููุงุนุจูู ุงูุฌุฏุฏ ุชุณุงุนุฏูู ุนูู ุงูุจุฏุก ุจุดูู ุตุญูุญ ูุชุฌูุจ ุงูุฃุฎุทุงุก ุงูุดุงุฆุนุฉ. ุชุดูู ุฃุณุงุณูุงุช ุงููุนุจ ูุงุฎุชูุงุฑ ุงูุงุณุชุฑุงุชูุฌูุฉ ุงูููุงุณุจุฉ.\n\nุงููุตุงุฆุญ ุงูุฃุณุงุณูุฉ:\n1. ุชุนูู ุฃุณุงุณูุงุช ุจูุงุก ุงููุงุนุฏุฉ\n2. ุงุฎุชุฑ ุฌูุฑุงู ูุงุญุฏ ูุชุฎุตุต ููู\n3. ุชุฏุฑุจ ุนูู ุงูุฎุฑุงุฆุท ุงูููุงุณูููุฉ\n4. ุดุงูุฏ ุงููุจุงุฑูุงุช ุงูุชูุงูุณูุฉ\n5. ุงูุถู ููุฌุชูุน ุงููุงุนุจูู\n\nุงูุตุจุฑ ูุงูุชูุฑูู ููุง ููุชุงุญ ุงููุฌุงุญ!',
            1, 'ูุนูู ุงููุจุชุฏุฆูู', 1, 'ุงูููุงุดุงุช ุงูุนุงูุฉ', '#4F9CF9', 523, 41, 27, 0, 0
        ],
        [
            'ุชุญุฏูุซ ุฌุฏูุฏ: ุฅุถุงูุงุช ุฑุงุฆุนุฉ ููุนุจุฉ!',
            'ุฅุนูุงู ุนู ุงูุชุญุฏูุซ ุงูุฌุฏูุฏ ููุนุจุฉ ูุน ุฅุถุงูุงุช ูุซูุฑุฉ ููุญุฏุงุช ุฌุฏูุฏุฉ ูุชุญุณููุงุช ูู ุงูุชูุงุฒู. ุงูุชุญุฏูุซ ูุชุงุญ ุงูุขู ููุชุญููู.\n\nูุง ุงูุฌุฏูุฏ:\n- 3 ูุญุฏุงุช ุฌุฏูุฏุฉ\n- ุชุญุณููุงุช ูู ุงูุชูุงุฒู\n- ุฎุฑุงุฆุท ุฅุถุงููุฉ\n- ุฅุตูุงุญ ุงูุฃุฎุทุงุก\n\nุญุฌู ุงูุชุญุฏูุซ: 2.5 GB',
            1, 'ุฃุฎุจุงุฑ ุงููุนุจุฉ', 1, 'ุงูููุงุดุงุช ุงูุนุงูุฉ', '#4F9CF9', 789, 52, 31, 1, 0
        ],
        [
            'ุงุณุชุฑุงุชูุฌูุฉ ุงูุตูู ุงููุชูุฏูุฉ - ุชูุชููุงุช ุงููุฌูู ุงูุณุฑูุน',
            'ุฏููู ูุชุฎุตุต ููุนุจ ุจุงูุตูู ูุน ุงูุชุฑููุฒ ุนูู ุชูุชููุงุช ุงููุฌูู ุงูุณุฑูุน ูุงููุฌูุงุช ุงูููุงุฌุฆุฉ. ููุงุณุจ ููุงุนุจูู ุงููุชูุฏููู.\n\nุงูุชูุชููุงุช ุงููุบุทุงุฉ:\n- ุงููุฌูู ุจุงูุฏุจุงุจุงุช ุงูุณุฑูุนุฉ\n- ุชูุชููุงุช ุงูุทูุฑุงู\n- ุงูุญุฑุจ ุงูููููุฉ\n- ุงูุณูุทุฑุฉ ุนูู ุงูููุงุฑุฏ\n\nูุน ุฃูุซูุฉ ุนูููุฉ ูููุงุทุน ููุฏูู ุชูุถูุญูุฉ.',
            1, 'ุฎุจูุฑ ุงูุตูู', 2, 'ุงูุงุณุชุฑุงุชูุฌูุงุช ูุงูุชูุชููุงุช', '#06D6A0', 345, 29, 16, 0, 1
        ]
    ];
    
    $insertPost = $pdo->prepare("
        INSERT INTO forum_posts (title, content, author_id, author_username, category_id, category_name, category_color, view_count, like_count, comment_count, is_pinned, is_featured) 
        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    ");
    
    foreach ($posts as $post) {
        $insertPost->execute($post);
    }
    echo "Inserted sample posts\n";
    
    // Insert sample comments
    $comments = [
        [1, 'ุดูุฑุงู ูู ุนูู ูุฐุง ุงูุฏููู ุงูุฑุงุฆุน! ูููุฏ ุฌุฏุงู ููุงุนุจูู ุงูุฌุฏุฏ ูุน ุฃูุฑููุง', 1, 'ูุงุนุจ ูุชุญูุณ', 3],
        [1, 'ูู ููููู ุฅุถุงูุฉ ูุณู ุนู ุงูุชุนุงูู ูุน ุงููุฌูุงุช ุงูุฌููุฉุ', 1, 'ุทูุงุฑ ูุงูุฑ', 1],
        [1, 'ุฌุฑุจุช ุงูุงุณุชุฑุงุชูุฌูุฉ ููู ูุนุงูุฉ ุฌุฏุงู! ุดูุฑุงู', 1, 'ูุฌุฑุจ ุงูุงุณุชุฑุงุชูุฌูุงุช', 5],
        [2, 'ูุชู ุณูุจุฏุฃ ุงูุชุณุฌููุ ููุชู ุงูููุนุฏ ุงูููุงุฆูุ', 1, 'ูุดุงุฑู ูุญุชูู', 2],
        [2, 'ุงูุฌูุงุฆุฒ ููุชุงุฒุฉ! ุณุฃุดุงุฑู ุจุงูุชุฃููุฏ', 1, 'ุจุทู ุณุงุจู', 5],
        [2, 'ูู ููุงู ูููุฏ ุนูู ุงููุดุงุฑูุฉุ', 1, 'ุณุงุฆู', 1],
        [3, 'ุฌุฑุจุช ุงูุฎุฑูุทุฉ ุงูุฃููู ููู ุฑุงุฆุนุฉ ููุนุจ 4v4', 1, 'ูุญุจู ุงูุฌูุงุนู', 4],
        [3, 'ูู ููุงู ุฎุฑุงุฆุท ููุนุจ ุงููุฑุฏู ุฃูุถุงูุ', 1, 'ูุงุนุจ ูููุฑุฏ', 2],
        [4, 'ุทุฑููุฉ ููุชุงุฒุฉุ ุญูุช ุงููุดููุฉ ุนูุฏู ููุฑุงู!', 1, 'ูุณุชุฎุฏู ูุดููุฑ', 8],
        [4, 'ุฌุฑุจุช ุงูุญู ููู ูุนูู ูุนูุ ูู ููุงู ุทุฑููุฉ ุฃุฎุฑูุ', 1, 'ูุญุชุงุฌ ูุณุงุนุฏุฉ', 0],
        [5, 'ุฃูุง ููุชู! ููู ูููููู ุงูุชูุงุตู ูุนูุ', 1, 'ูุงุนุจ ุทููุญ', 3],
        [6, 'ูุตุงุฆุญ ูููุฏุฉ ุฌุฏุงูุ ุดูุฑุงู ูู!', 1, 'ูุจุชุฏุฆ ุดุงูุฑ', 6],
        [7, 'ูุชุญูุณ ููุชุญุฏูุซ ุงูุฌุฏูุฏ! ูุชู ุณูููู ูุชุงุญุงูุ', 1, 'ููุชุธุฑ ุงูุชุญุฏูุซ', 4],
        [8, 'ุงุณุชุฑุงุชูุฌูุฉ ุฑุงุฆุนุฉ! ูู ุชุนูู ุถุฏ ุฌููุน ุงูุฌูุฑุงูุงุชุ', 1, 'ูุญูู ุชูุชููู', 2]
    ];
    
    $insertComment = $pdo->prepare("
        INSERT INTO forum_comments (post_id, content, author_id, author_username, like_count) 
        VALUES (?, ?, ?, ?, ?)
    ");
    
    foreach ($comments as $comment) {
        $insertComment->execute($comment);
    }
    echo "Inserted sample comments\n";
    
    echo "\nโ Forum database setup completed successfully!\n";
    echo "Tables created:\n";
    echo "- forum_categories (6 sample categories)\n";
    echo "- forum_posts (8 sample posts)\n"; 
    echo "- forum_comments (14 sample comments)\n";
    echo "- forum_likes (structure ready)\n";
    
    echo "\n๐ Forum API endpoints:\n";
    echo "- GET categories: http://localhost:8080/forum_api.php?action=get_categories\n";
    echo "- GET posts: http://localhost:8080/forum_api.php?action=get_posts\n";
    echo "- GET stats: http://localhost:8080/forum_api.php?action=get_stats\n";
    
} catch (PDOException $e) {
    echo "โ Error: " . $e->getMessage() . "\n";
}
?>

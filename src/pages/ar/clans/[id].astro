---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import ClanMembers from '../../../components/clans/ClanMembers.tsx';
import ClanStats from '../../../components/clans/ClanStats.tsx';
import ClanMessaging from '../../../components/clans/ClanMessaging.tsx';
import { Shield, Users, Trophy, Crown, ArrowLeft, MessageCircle, Share2, Flag, Settings } from 'lucide-react';

// Get clan ID from URL params
const { id } = Astro.params;

// Mock clan data
const mockClan = {
  id: parseInt(id || '1'),
  name: 'نسور الشرق',
  tag: 'EAST',
  description: 'عشيرة نخبة للاعبين المحترفين في الشرق الأوسط. ننافس في أعلى المستويات ونسعى للتميز دائماً. انضم إلينا وكن جزءاً من الأساطير.',
  level: 45,
  totalMembers: 48,
  maxMembers: 50,
  activeMembers: 42,
  joinRequirements: {
    minLevel: 30,
    minWinRate: 75,
    applicationRequired: true
  },
  stats: {
    totalWins: 2850,
    totalLosses: 420,
    winRate: 87,
    totalTrophies: 125000,
    totalXP: 450000,
    warWins: 156,
    warLosses: 23,
    warWinRate: 87
  },
  leader: {
    id: 1,
    username: 'سلطان_الحرب',
    avatar: '/avatars/leader1.png',
    isOnline: true
  },
  officers: [
    {
      id: 2,
      username: 'قائد_النصر',
      avatar: '/avatars/officer1.png',
      isOnline: true
    }
  ],
  region: 'الشرق الأوسط',
  language: 'العربية',
  isPublic: false,
  createdAt: '2022-03-15T10:00:00Z',
  lastActivity: '2024-01-15T18:30:00Z',
  avatar: '/clans/east-eagles.png',
  banner: '/banners/east-eagles-banner.jpg',
  membershipStatus: 'none',
  isRecruiting: true,
  tags: ['professional', 'competitive', 'elite'],
  isVerified: true,
  isElite: true
};

// Mock members data
const mockMembers = [
  {
    id: 1,
    username: 'سلطان_الحرب',
    avatar: '/avatars/leader1.png',
    role: 'leader' as const,
    level: 50,
    rank: 'Legend',
    isOnline: true,
    joinedAt: '2022-03-15T10:00:00Z',
    lastActive: '2024-01-15T18:30:00Z',
    stats: {
      totalGames: 1500,
      wins: 1350,
      losses: 150,
      winRate: 90,
      trophies: 5500,
      contributions: 2500
    },
    permissions: {
      canInvite: true,
      canKick: true,
      canPromote: true,
      canManageWars: true
    },
    country: 'السعودية',
    verified: true
  },
  {
    id: 2,
    username: 'قائد_النصر',
    avatar: '/avatars/officer1.png',
    role: 'officer' as const,
    level: 45,
    rank: 'Master',
    isOnline: true,
    joinedAt: '2022-04-20T14:00:00Z',
    lastActive: '2024-01-15T17:45:00Z',
    stats: {
      totalGames: 1200,
      wins: 1020,
      losses: 180,
      winRate: 85,
      trophies: 4800,
      contributions: 2100
    },
    permissions: {
      canInvite: true,
      canKick: true,
      canPromote: false,
      canManageWars: true
    },
    country: 'الإمارات',
    verified: true
  }
  // Add more members...
];

// Mock clan statistics
const mockStats = {
  overall: {
    totalMembers: 48,
    activeMembers: 42,
    level: 45,
    xp: 750000,
    xpToNextLevel: 250000,
    trophies: 125000,
    averageTrophies: 2604,
    totalWins: 2850,
    totalLosses: 420,
    winRate: 87
  },
  wars: {
    totalWars: 179,
    warsWon: 156,
    warsLost: 23,
    warWinRate: 87,
    currentStreak: 12,
    bestStreak: 28,
    totalStars: 4280,
    averageStars: 24
  },
  members: {
    newMembersThisWeek: 2,
    newMembersThisMonth: 8,
    activeMembersToday: 35,
    topContributor: {
      username: 'سلطان_الحرب',
      contributions: 2500
    },
    mostImproved: {
      username: 'محارب_الصحراء',
      improvement: 350
    }
  },
  activity: {
    totalGames: 15680,
    gamesThisWeek: 245,
    averageGamesPerMember: 12,
    peakActiveTime: '20:00-22:00',
    mostActiveDay: 'الجمعة'
  }
};

const title = `${mockClan.name} - العشائر - زد اتش لوف`;
const description = mockClan.description;
---

<BaseLayout title={title} description={description}>
  <div class="container-custom py-8">
    <!-- Navigation -->
    <div class="mb-6">
      <nav class="flex items-center space-x-2 rtl:space-x-reverse text-sm text-muted-foreground">
        <a href="/ar" class="hover:text-foreground transition-colors">الرئيسية</a>
        <span>/</span>
        <a href="/ar/clans" class="hover:text-foreground transition-colors">العشائر</a>
        <span>/</span>
        <span class="text-foreground">[{mockClan.tag}] {mockClan.name}</span>
      </nav>
    </div>

    <!-- Back Button -->
    <div class="mb-6">
      <a 
        href="/ar/clans" 
        class="inline-flex items-center space-x-2 rtl:space-x-reverse text-muted-foreground hover:text-foreground transition-colors"
      >
        <ArrowLeft size={20} class="rtl:rotate-180" />
        <span>العودة للعشائر</span>
      </a>
    </div>

    <!-- Clan Header -->
    <div class="relative mb-8">
      {mockClan.banner && (
        <div class="relative h-64 rounded-lg overflow-hidden mb-6">
          <img 
            src={mockClan.banner} 
            alt={mockClan.name}
            class="w-full h-full object-cover"
          />
          <div class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent"></div>
          <div class="absolute bottom-6 left-6 right-6 text-white">
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-4 rtl:space-x-reverse">
                <img 
                  src={mockClan.avatar} 
                  alt={mockClan.name}
                  class="w-20 h-20 rounded-lg border-4 border-white"
                />
                <div>
                  <h1 class="text-3xl font-bold mb-1">[{mockClan.tag}] {mockClan.name}</h1>
                  <p class="text-lg opacity-90">{mockClan.description}</p>
                  <div class="flex items-center space-x-4 rtl:space-x-reverse mt-2">
                    <span class="text-sm bg-white/20 px-2 py-1 rounded">Level {mockClan.level}</span>
                    <span class="text-sm bg-white/20 px-2 py-1 rounded">{mockClan.region}</span>
                    {mockClan.isElite && (
                      <span class="text-sm bg-victory-gold/20 px-2 py-1 rounded flex items-center space-x-1 rtl:space-x-reverse">
                        <Crown size={14} />
                        <span>نخبة</span>
                      </span>
                    )}
                  </div>
                </div>
              </div>
              <div class="flex items-center space-x-2 rtl:space-x-reverse">
                <button class="btn btn-outline btn-sm text-white border-white hover:bg-white hover:text-black">
                  <Share2 size={16} />
                  <span>مشاركة</span>
                </button>
                <button class="btn btn-outline btn-sm text-white border-white hover:bg-white hover:text-black">
                  <Flag size={16} />
                  <span>إبلاغ</span>
                </button>
                {mockClan.membershipStatus === 'leader' && (
                  <button class="btn btn-primary btn-sm">
                    <Settings size={16} />
                    <span>إدارة العشيرة</span>
                  </button>
                )}
              </div>
            </div>
          </div>
        </div>
      )}
    </div>

    <!-- Clan Info Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
      <div class="military-card p-4 text-center">
        <Users size={24} class="mx-auto text-tactical-green mb-2" />
        <div class="text-xl font-bold text-foreground">{mockClan.totalMembers}/{mockClan.maxMembers}</div>
        <div class="text-sm text-muted-foreground">الأعضاء</div>
        <div class="text-xs text-tactical-green mt-1">{mockClan.activeMembers} نشط</div>
      </div>
      <div class="military-card p-4 text-center">
        <Trophy size={24} class="mx-auto text-victory-gold mb-2" />
        <div class="text-xl font-bold text-foreground">{mockStats.overall.trophies.toLocaleString()}</div>
        <div class="text-sm text-muted-foreground">الكؤوس</div>
        <div class="text-xs text-muted-foreground mt-1">متوسط {mockStats.overall.averageTrophies}</div>
      </div>
      <div class="military-card p-4 text-center">
        <div class="text-xl font-bold text-foreground">{mockStats.overall.winRate}%</div>
        <div class="text-sm text-muted-foreground">معدل الفوز</div>
        <div class="text-xs text-muted-foreground mt-1">{mockStats.overall.totalWins}W/{mockStats.overall.totalLosses}L</div>
      </div>
      <div class="military-card p-4 text-center">
        <div class="text-xl font-bold text-foreground">{mockStats.wars.warWinRate}%</div>
        <div class="text-sm text-muted-foreground">فوز الحروب</div>
        <div class="text-xs text-muted-foreground mt-1">{mockStats.wars.warsWon}/{mockStats.wars.warsLost} حرب</div>
      </div>
    </div>

    <!-- Join Requirements -->
    <div class="military-card p-6 mb-8">
      <h2 class="text-xl font-bold text-foreground mb-4">متطلبات الانضمام</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="text-center">
          <div class="text-2xl font-bold text-command-blue">Level {mockClan.joinRequirements.minLevel}+</div>
          <div class="text-sm text-muted-foreground">الحد الأدنى للمستوى</div>
        </div>
        <div class="text-center">
          <div class="text-2xl font-bold text-tactical-green">{mockClan.joinRequirements.minWinRate}%+</div>
          <div class="text-sm text-muted-foreground">معدل الفوز المطلوب</div>
        </div>
        <div class="text-center">
          <div class="text-2xl font-bold text-victory-gold">
            {mockClan.joinRequirements.applicationRequired ? 'مطلوب' : 'غير مطلوب'}
          </div>
          <div class="text-sm text-muted-foreground">طلب انضمام</div>
        </div>
      </div>
      
      <div class="flex justify-center mt-6">
        {mockClan.membershipStatus === 'none' && mockClan.isRecruiting && (
          <button class="btn btn-primary">
            {mockClan.joinRequirements.applicationRequired ? 'تقديم طلب انضمام' : 'انضمام للعشيرة'}
          </button>
        )}
        {mockClan.membershipStatus === 'member' && (
          <div class="flex items-center space-x-4 rtl:space-x-reverse">
            <span class="text-tactical-green font-semibold">أنت عضو في هذه العشيرة</span>
            <button class="btn btn-outline text-alert-red hover:bg-alert-red hover:text-white">
              مغادرة العشيرة
            </button>
          </div>
        )}
      </div>
    </div>

    <!-- Clan Tabs -->
    <div class="mb-8">
      <div class="border-b border-border">
        <nav class="flex space-x-8 rtl:space-x-reverse">
          <button 
            class="py-2 px-1 border-b-2 border-primary text-primary font-medium text-sm"
            onclick="showTab('members')"
          >
            الأعضاء
          </button>
          <button 
            class="py-2 px-1 border-b-2 border-transparent text-muted-foreground hover:text-foreground font-medium text-sm"
            onclick="showTab('stats')"
          >
            الإحصائيات
          </button>
          <button 
            class="py-2 px-1 border-b-2 border-transparent text-muted-foreground hover:text-foreground font-medium text-sm"
            onclick="showTab('wars')"
          >
            الحروب
          </button>
          <button 
            class="py-2 px-1 border-b-2 border-transparent text-muted-foreground hover:text-foreground font-medium text-sm"
            onclick="showTab('chat')"
          >
            الدردشة
          </button>
        </nav>
      </div>
    </div>

    <!-- Tab Content -->
    <div id="members-tab" class="tab-content">
      <ClanMembers 
        members={mockMembers}
        currentUserRole="member"
        currentUserId={1}
        onPromote={(id) => console.log('Promote member:', id)}
        onDemote={(id) => console.log('Demote member:', id)}
        onKick={(id) => console.log('Kick member:', id)}
        onInvite={() => console.log('Invite member')}
        onMessage={(id) => console.log('Message member:', id)}
        client:load
      />
    </div>

    <div id="stats-tab" class="tab-content hidden">
      <ClanStats 
        stats={mockStats}
        history={[]}
        achievements={[]}
        wars={[]}
        client:load
      />
    </div>

    <div id="wars-tab" class="tab-content hidden">
      <div class="military-card p-6">
        <h2 class="text-xl font-bold text-foreground mb-4">حروب العشيرة</h2>
        <p class="text-muted-foreground">سيتم عرض تفاصيل حروب العشيرة هنا</p>
      </div>
    </div>

    <div id="chat-tab" class="tab-content hidden">
      <ClanMessaging 
        clanId={mockClan.id}
        currentUserId={1}
        currentUserRole="member"
        client:load
      />
    </div>
  </div>
</BaseLayout>

<script>
  function showTab(tabName) {
    // Hide all tab contents
    const tabs = document.querySelectorAll('.tab-content');
    tabs.forEach(tab => tab.classList.add('hidden'));
    
    // Show selected tab
    document.getElementById(tabName + '-tab').classList.remove('hidden');
    
    // Update tab buttons
    const buttons = document.querySelectorAll('nav button');
    buttons.forEach(button => {
      button.classList.remove('border-primary', 'text-primary');
      button.classList.add('border-transparent', 'text-muted-foreground');
    });
    
    // Activate selected button
    event.target.classList.remove('border-transparent', 'text-muted-foreground');
    event.target.classList.add('border-primary', 'text-primary');
  }
</script> 
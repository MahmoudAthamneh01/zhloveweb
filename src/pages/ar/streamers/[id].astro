---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import StreamerStats from '../../../components/streamers/StreamerStats.tsx';
import VideoPlayer from '../../../components/streamers/VideoPlayer.tsx';
import { Youtube, Twitch, Users, Eye, Calendar, ArrowLeft, Bell, Share2, Flag, Play, Star, Heart } from 'lucide-react';

// Get streamer ID from URL params
const { id } = Astro.params;

// Mock streamer data
const mockStreamer = {
  id: parseInt(id || '1'),
  username: 'sultan_commander',
  displayName: 'سلطان القائد',
  avatar: '/avatars/sultan_commander.png',
  banner: '/banners/sultan_banner.jpg',
  description: 'أحد أفضل لاعبي الجنرالات في الشرق الأوسط. أقدم محتوى تعليمي وتنافسي منذ 2018. خبرة واسعة في جميع الفصائل مع تركيز خاص على تكتيكات USA المتقدمة.',
  verified: true,
  isOnline: true,
  platforms: [
    {
      type: 'youtube',
      followers: 125000,
      subscribers: 125000,
      totalViews: 8500000,
      verified: true
    },
    {
      type: 'twitch',
      followers: 45000,
      totalViews: 2100000,
      verified: false
    }
  ],
  overallStats: {
    totalFollowers: 170000,
    totalViews: 10600000,
    totalVideos: 450,
    totalLikes: 850000,
    totalComments: 125000,
    totalShares: 45000,
    averageViews: 23600,
    averageEngagement: 12.5,
    rating: 4.8,
    totalRatings: 1240
  },
  recentStats: {
    period: 'آخر 30 يوم',
    views: 520000,
    viewsChange: 15.2,
    followers: 8500,
    followersChange: 12.8,
    engagement: 14.2,
    engagementChange: 8.5,
    videosUploaded: 12,
    avgViewDuration: 680,
    topVideo: {
      id: 'top1',
      title: 'أسرار تكتيكات USA المتقدمة - دليل شامل',
      views: 85000,
      thumbnail: '/thumbnails/usa_tactics.jpg'
    }
  },
  contentStats: {
    uploadFrequency: 3,
    averageVideoDuration: 1200,
    mostPopularHour: '20:00',
    mostPopularDay: 'الخميس',
    topCategories: [
      { category: 'تعليمي', count: 180, percentage: 40 },
      { category: 'تنافسي', count: 135, percentage: 30 },
      { category: 'تحليل', count: 90, percentage: 20 },
      { category: 'ترفيهي', count: 45, percentage: 10 }
    ],
    topTags: [
      { tag: 'usa', count: 120 },
      { tag: 'strategy', count: 95 },
      { tag: 'tutorial', count: 85 },
      { tag: 'competitive', count: 70 }
    ]
  },
  audienceStats: {
    demographics: {
      ageGroups: [
        { range: '18-24', percentage: 35 },
        { range: '25-34', percentage: 45 },
        { range: '35-44', percentage: 15 },
        { range: '45+', percentage: 5 }
      ],
      genders: [
        { type: 'male', percentage: 85 },
        { type: 'female', percentage: 15 }
      ],
      topCountries: [
        { country: 'السعودية', percentage: 40 },
        { country: 'مصر', percentage: 25 },
        { country: 'الإمارات', percentage: 15 },
        { country: 'الكويت', percentage: 10 },
        { country: 'قطر', percentage: 10 }
      ]
    },
    engagement: {
      avgWatchTime: 680,
      returnViewers: 72,
      newViewers: 28,
      commentRate: 8.5,
      likeRate: 12.8,
      shareRate: 2.1
    }
  },
  gameStats: {
    totalPlaytime: 2400,
    favoriteGeneral: 'USA',
    gamesPlayed: 1850,
    winRate: 89,
    rank: 'Grandmaster',
    level: 87,
    achievements: 45,
    mostPlayedMaps: [
      { map: 'Tournament Desert', count: 180 },
      { map: 'Scorched Earth', count: 145 },
      { map: 'Winter Wolf', count: 120 }
    ]
  },
  milestones: [
    {
      id: 'm1',
      type: 'followers',
      value: 100000,
      achievedAt: '2023-08-15T00:00:00Z',
      description: 'وصل إلى 100,000 متابع على YouTube'
    },
    {
      id: 'm2',
      type: 'views',
      value: 10000000,
      achievedAt: '2023-12-01T00:00:00Z',
      description: 'تجاوز 10 مليون مشاهدة إجمالية'
    }
  ],
  collaborations: [
    {
      id: 'c1',
      partner: {
        id: 2,
        username: 'desert_warrior',
        displayName: 'محارب الصحراء',
        avatar: '/avatars/desert_warrior.png'
      },
      type: 'video',
      title: 'معركة الأساطير: USA vs GLA',
      views: 125000,
      date: '2024-01-10T00:00:00Z'
    }
  ],
  country: 'السعودية',
  language: 'ar',
  joinedAt: '2018-03-15T00:00:00Z',
  lastActivity: '2024-01-15T20:30:00Z',
  isFollowed: false,
  contentType: 'tutorials',
  schedule: {
    timezone: 'GMT+3',
    days: ['الأحد', 'الثلاثاء', 'الخميس'],
    time: '20:00'
  }
};

// Mock recent videos
const recentVideos = [
  {
    id: 'v1',
    title: 'أسرار تكتيكات USA المتقدمة - دليل شامل',
    description: 'في هذا الفيديو سنتعلم أهم التكتيكات المتقدمة لفصيل USA وكيفية تطبيقها في المباريات التنافسية.',
    thumbnail: '/thumbnails/usa_tactics.jpg',
    videoUrl: '/videos/usa_tactics.mp4',
    duration: 1680,
    views: 45000,
    likes: 2800,
    dislikes: 45,
    publishedAt: '2024-01-15T10:00:00Z',
    updatedAt: '2024-01-15T10:00:00Z',
    streamer: mockStreamer,
    category: 'tutorial',
    tags: ['usa', 'strategy', 'tutorial', 'advanced'],
    gameInfo: {
      map: 'Tournament Desert',
      faction: 'USA',
      gameMode: 'Skirmish',
      difficulty: 'Hard'
    },
    isLive: false,
    quality: [
      { label: '1080p', value: '1080p', url: '/videos/usa_tactics_1080p.mp4' },
      { label: '720p', value: '720p', url: '/videos/usa_tactics_720p.mp4' },
      { label: '480p', value: '480p', url: '/videos/usa_tactics_480p.mp4' }
    ],
    comments: [
      {
        id: 'c1',
        user: {
          id: 2,
          username: 'viewer1',
          avatar: '/avatars/viewer1.png'
        },
        content: 'شرح ممتاز! استفدت كثيراً من هذا الفيديو',
        timestamp: '2024-01-15T12:00:00Z',
        likes: 15,
        replies: [
          {
            id: 'r1',
            user: {
              id: 1,
              username: 'sultan_commander',
              avatar: '/avatars/sultan_commander.png'
            },
            content: 'شكراً لك! سعيد أن الفيديو كان مفيداً',
            timestamp: '2024-01-15T12:30:00Z'
          }
        ]
      }
    ],
    isLiked: false,
    isDisliked: false,
    isSubscribed: false
  }
];

const title = `${mockStreamer.displayName} - الستريمرز - زد اتش لوف`;
const description = mockStreamer.description;
---

<BaseLayout title={title} description={description}>
  <div class="container-custom py-8">
    <!-- Navigation -->
    <div class="mb-6">
      <nav class="flex items-center space-x-2 rtl:space-x-reverse text-sm text-muted-foreground">
        <a href="/ar" class="hover:text-foreground transition-colors">الرئيسية</a>
        <span>/</span>
        <a href="/ar/streamers" class="hover:text-foreground transition-colors">الستريمرز</a>
        <span>/</span>
        <span class="text-foreground">{mockStreamer.displayName}</span>
      </nav>
    </div>

    <!-- Back Button -->
    <div class="mb-6">
      <a 
        href="/ar/streamers" 
        class="inline-flex items-center space-x-2 rtl:space-x-reverse text-muted-foreground hover:text-foreground transition-colors"
      >
        <ArrowLeft size={20} class="rtl:rotate-180" />
        <span>العودة للستريمرز</span>
      </a>
    </div>

    <!-- Channel Header -->
    <div class="relative mb-8">
      {mockStreamer.banner && (
        <div class="relative h-64 rounded-lg overflow-hidden mb-6">
          <img 
            src={mockStreamer.banner} 
            alt={mockStreamer.displayName}
            class="w-full h-full object-cover"
          />
          <div class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent"></div>
          {mockStreamer.isOnline && (
            <div class="absolute top-4 right-4 bg-red-500 text-white px-3 py-1 rounded-full text-sm font-medium flex items-center space-x-1 rtl:space-x-reverse">
              <div class="w-2 h-2 bg-white rounded-full animate-pulse"></div>
              <span>مباشر الآن</span>
            </div>
          )}
        </div>
      )}

      <div class="flex items-start space-x-4 rtl:space-x-reverse">
        <img 
          src={mockStreamer.avatar} 
          alt={mockStreamer.displayName}
          class="w-24 h-24 rounded-full border-4 border-border flex-shrink-0"
        />
        <div class="flex-1 min-w-0">
          <div class="flex items-center space-x-2 rtl:space-x-reverse mb-2">
            <h1 class="text-3xl font-bold text-foreground">{mockStreamer.displayName}</h1>
            {mockStreamer.verified && (
              <div class="text-tactical-green">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
              </div>
            )}
          </div>
          <p class="text-muted-foreground mb-2">@{mockStreamer.username}</p>
          <div class="flex items-center space-x-4 rtl:space-x-reverse text-sm text-muted-foreground mb-4">
            <div class="flex items-center space-x-1 rtl:space-x-reverse">
              <Users size={16} />
              <span>{mockStreamer.overallStats.totalFollowers.toLocaleString()} متابع</span>
            </div>
            <div class="flex items-center space-x-1 rtl:space-x-reverse">
              <Eye size={16} />
              <span>{mockStreamer.overallStats.totalViews.toLocaleString()} مشاهدة</span>
            </div>
            <div class="flex items-center space-x-1 rtl:space-x-reverse">
              <Play size={16} />
              <span>{mockStreamer.overallStats.totalVideos} فيديو</span>
            </div>
          </div>
          <p class="text-foreground mb-4">{mockStreamer.description}</p>
          
          {/* Platforms */}
          <div class="flex items-center space-x-3 rtl:space-x-reverse mb-4">
            {mockStreamer.platforms.map((platform, index) => (
              <a 
                key={index}
                href={`#platform-${platform.type}`}
                class="flex items-center space-x-2 rtl:space-x-reverse bg-muted hover:bg-muted/80 px-3 py-2 rounded-lg transition-colors"
              >
                {platform.type === 'youtube' && <Youtube size={16} class="text-red-500" />}
                {platform.type === 'twitch' && <Twitch size={16} class="text-purple-500" />}
                <span class="text-sm font-medium">{platform.followers.toLocaleString()} متابع</span>
                {platform.verified && (
                  <div class="text-tactical-green">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                  </div>
                )}
              </a>
            ))}
          </div>

          {/* Schedule */}
          {mockStreamer.schedule && (
            <div class="bg-muted rounded-lg p-3 mb-4">
              <h4 class="font-medium text-foreground mb-2">جدول البث</h4>
              <div class="text-sm text-muted-foreground">
                <div>{mockStreamer.schedule.days.join(', ')}</div>
                <div>الساعة {mockStreamer.schedule.time} ({mockStreamer.schedule.timezone})</div>
              </div>
            </div>
          )}
        </div>
        
        <div class="flex items-center space-x-2 rtl:space-x-reverse">
          <button class={`btn ${mockStreamer.isFollowed ? 'btn-outline' : 'btn-primary'}`}>
            <Heart size={16} />
            <span>{mockStreamer.isFollowed ? 'ملاحظة' : 'متابعة'}</span>
          </button>
          <button class="btn btn-outline">
            <Bell size={16} />
            <span>إشعارات</span>
          </button>
          <button class="btn btn-outline">
            <Share2 size={16} />
            <span>مشاركة</span>
          </button>
          <button class="btn btn-outline text-alert-red">
            <Flag size={16} />
            <span>إبلاغ</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Stats Overview -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
      <div class="military-card p-4 text-center">
        <div class="text-2xl font-bold text-foreground">{mockStreamer.overallStats.averageViews.toLocaleString()}</div>
        <div class="text-sm text-muted-foreground">متوسط المشاهدات</div>
      </div>
      <div class="military-card p-4 text-center">
        <div class="text-2xl font-bold text-foreground">{mockStreamer.overallStats.averageEngagement}%</div>
        <div class="text-sm text-muted-foreground">معدل التفاعل</div>
      </div>
      <div class="military-card p-4 text-center">
        <div class="text-2xl font-bold text-foreground">{mockStreamer.overallStats.rating}</div>
        <div class="text-sm text-muted-foreground">التقييم</div>
      </div>
      <div class="military-card p-4 text-center">
        <div class="text-2xl font-bold text-foreground">{mockStreamer.gameStats.rank}</div>
        <div class="text-sm text-muted-foreground">رتبة اللعبة</div>
      </div>
    </div>

    <!-- Content Tabs -->
    <div class="mb-8">
      <div class="border-b border-border">
        <nav class="flex space-x-8 rtl:space-x-reverse">
          <button 
            class="py-2 px-1 border-b-2 border-primary text-primary font-medium text-sm"
            onclick="showTab('videos')"
          >
            الفيديوهات
          </button>
          <button 
            class="py-2 px-1 border-b-2 border-transparent text-muted-foreground hover:text-foreground font-medium text-sm"
            onclick="showTab('stats')"
          >
            الإحصائيات
          </button>
          <button 
            class="py-2 px-1 border-b-2 border-transparent text-muted-foreground hover:text-foreground font-medium text-sm"
            onclick="showTab('about')"
          >
            حول القناة
          </button>
        </nav>
      </div>
    </div>

    <!-- Tab Content -->
    <div id="videos-tab" class="tab-content">
      {/* Latest Video Player */}
      {recentVideos.length > 0 && (
        <div class="mb-8">
          <h2 class="text-xl font-bold text-foreground mb-4">أحدث فيديو</h2>
          <VideoPlayer 
            video={recentVideos[0]}
            onLike={(id) => console.log('Like video:', id)}
            onDislike={(id) => console.log('Dislike video:', id)}
            onShare={(id) => console.log('Share video:', id)}
            onDownload={(id) => console.log('Download video:', id)}
            onFlag={(id) => console.log('Flag video:', id)}
            onComment={(id, comment) => console.log('Comment:', id, comment)}
            autoPlay={false}
            showComments={true}
            client:load
          />
        </div>
      )}

      {/* Video Grid */}
      <div class="mb-8">
        <h2 class="text-xl font-bold text-foreground mb-4">الفيديوهات الأخيرة</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {/* Video placeholder cards */}
          {Array.from({ length: 6 }).map((_, index) => (
            <div key={index} class="bg-card border border-border rounded-lg overflow-hidden">
              <div class="aspect-video bg-muted flex items-center justify-center">
                <Play class="text-muted-foreground" size={48} />
              </div>
              <div class="p-4">
                <h3 class="font-semibold text-foreground mb-2">عنوان الفيديو {index + 1}</h3>
                <div class="flex items-center space-x-2 rtl:space-x-reverse text-sm text-muted-foreground">
                  <Eye size={14} />
                  <span>15,000 مشاهدة</span>
                  <span>•</span>
                  <Calendar size={14} />
                  <span>منذ 3 أيام</span>
                </div>
              </div>
            </div>
          ))}
        </div>
      </div>
    </div>

    <div id="stats-tab" class="tab-content hidden">
      <StreamerStats 
        streamer={mockStreamer}
        timeRange="30d"
        onTimeRangeChange={(range) => console.log('Time range changed:', range)}
        client:load
      />
    </div>

    <div id="about-tab" class="tab-content hidden">
      <div class="space-y-6">
        <div class="military-card p-6">
          <h3 class="text-lg font-semibold text-foreground mb-4">معلومات القناة</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <span class="text-muted-foreground">البلد:</span>
              <span class="font-medium ml-2">{mockStreamer.country}</span>
            </div>
            <div>
              <span class="text-muted-foreground">اللغة:</span>
              <span class="font-medium ml-2">العربية</span>
            </div>
            <div>
              <span class="text-muted-foreground">تاريخ الانضمام:</span>
              <span class="font-medium ml-2">مارس 2018</span>
            </div>
            <div>
              <span class="text-muted-foreground">نوع المحتوى:</span>
              <span class="font-medium ml-2">تعليمي</span>
            </div>
          </div>
        </div>

        <div class="military-card p-6">
          <h3 class="text-lg font-semibold text-foreground mb-4">إحصائيات اللعبة</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <span class="text-muted-foreground">الفصيل المفضل:</span>
              <span class="font-medium ml-2">🇺🇸 USA</span>
            </div>
            <div>
              <span class="text-muted-foreground">الرتبة:</span>
              <span class="font-medium ml-2">{mockStreamer.gameStats.rank}</span>
            </div>
            <div>
              <span class="text-muted-foreground">المستوى:</span>
              <span class="font-medium ml-2">{mockStreamer.gameStats.level}</span>
            </div>
            <div>
              <span class="text-muted-foreground">معدل الفوز:</span>
              <span class="font-medium ml-2">{mockStreamer.gameStats.winRate}%</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</BaseLayout>

<script>
  function showTab(tabName) {
    // Hide all tab contents
    const tabs = document.querySelectorAll('.tab-content');
    tabs.forEach(tab => tab.classList.add('hidden'));
    
    // Show selected tab
    document.getElementById(tabName + '-tab').classList.remove('hidden');
    
    // Update tab buttons
    const buttons = document.querySelectorAll('nav button');
    buttons.forEach(button => {
      button.classList.remove('border-primary', 'text-primary');
      button.classList.add('border-transparent', 'text-muted-foreground');
    });
    
    // Activate selected button
    event.target.classList.remove('border-transparent', 'text-muted-foreground');
    event.target.classList.add('border-primary', 'text-primary');
  }
</script> 
---
import BaseLayout from '../../../layouts/BaseLayout.astro';
---

<BaseLayout title="Ø¥Ø¹Ù„Ø§Ù† Ø­Ø±Ø¨ - Ø²Ø¯ Ø§ØªØ´ Ù„ÙˆÙ">
    <div class="container-custom py-8">
        <!-- Navigation -->
        <div class="mb-6">
            <nav class="flex items-center space-x-2 rtl:space-x-reverse text-sm text-muted-foreground">
                <a href="/ar" class="hover:text-foreground transition-colors">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
                <span>/</span>
                <a href="/ar/my-clan" class="hover:text-foreground transition-colors">Ø¹Ø´ÙŠØ±ØªÙŠ</a>
                <span>/</span>
                <span class="text-foreground">Ø¥Ø¹Ù„Ø§Ù† Ø­Ø±Ø¨</span>
            </nav>
        </div>

        <!-- Back Button -->
        <div class="mb-6">
            <a 
                href="/ar/my-clan" 
                class="inline-flex items-center space-x-2 rtl:space-x-reverse text-muted-foreground hover:text-foreground transition-colors"
            >
                <svg class="w-5 h-5 rtl:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
                <span>Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø¹Ø´ÙŠØ±Ø©</span>
            </a>
        </div>

        <!-- Main Content -->
        <div class="military-card p-6">
            <div class="flex items-center gap-3 mb-6">
                <div class="w-10 h-10 bg-alert-red rounded-lg flex items-center justify-center">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
                    </svg>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-foreground">Ø¥Ø¹Ù„Ø§Ù† Ø­Ø±Ø¨</h1>
                    <p class="text-muted-foreground">ØªØ­Ø¯Ù‰ Ø¹Ø´ÙŠØ±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø®ÙˆØ¶ Ù…Ø¹Ø±ÙƒØ© Ù…Ù„Ø­Ù…ÙŠØ©</p>
                </div>
            </div>

        <!-- War Declaration Form -->
        <div class="space-y-6">
            <!-- Step 1: Choose Clan -->
            <div class="military-card p-6">
                <h3 class="text-lg font-semibold text-foreground mb-4">1. Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ø´ÙŠØ±Ø© Ø§Ù„Ù…Ù†Ø§ÙØ³Ø©</h3>
                
                <div class="relative mb-4">
                    <input 
                        type="text" 
                        id="clanSearch"
                        placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø¹Ø´ÙŠØ±Ø©..." 
                        class="w-full bg-input border border-border rounded-lg px-4 py-3 text-foreground placeholder-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring"
                    >
                    <div id="clanSearchResults" class="absolute top-full left-0 right-0 bg-card border border-border rounded-b-lg max-h-60 overflow-y-auto hidden z-10">
                        <!-- Search results will appear here -->
                    </div>
                </div>

                <div id="selectedClan" class="hidden bg-muted rounded-lg p-4 border-2 border-alert-red">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-gradient-to-r from-alert-red to-orange-500 rounded-lg flex items-center justify-center">
                                <span class="text-white font-bold text-lg" id="selectedClanTag"></span>
                            </div>
                            <div>
                                <h4 class="text-foreground font-semibold" id="selectedClanName"></h4>
                                <p class="text-muted-foreground text-sm">Ø§Ù„Ù…Ø³ØªÙˆÙ‰: <span id="selectedClanLevel"></span> | Ø§Ù„Ù†Ù‚Ø§Ø·: <span id="selectedClanPoints"></span></p>
                            </div>
                        </div>
                        <button onclick="clearSelectedClan()" class="text-alert-red hover:text-alert-red/80">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Step 2: War Configuration -->
            <div class="military-card p-6">
                <h3 class="text-lg font-semibold text-foreground mb-4">2. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ø±Ø¨</h3>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- War Type -->
                    <div>
                        <label class="block text-sm font-medium text-foreground mb-2">Ù†ÙˆØ¹ Ø§Ù„Ø­Ø±Ø¨</label>
                        <select id="warType" class="w-full bg-input border border-border rounded-lg px-4 py-3 text-foreground focus:outline-none focus:ring-2 focus:ring-ring">
                            <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø­Ø±Ø¨...</option>
                        </select>
                    </div>

                    <!-- Map -->
                    <div>
                        <label class="block text-sm font-medium text-foreground mb-2">Ø§Ù„Ø®Ø±ÙŠØ·Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                        <select id="mapSelect" class="w-full bg-input border border-border rounded-lg px-4 py-3 text-foreground focus:outline-none focus:ring-2 focus:ring-ring">
                            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø®Ø±ÙŠØ·Ø©...</option>
                        </select>
                    </div>

                    <!-- Streamer -->
                    <div>
                        <label class="block text-sm font-medium text-foreground mb-2">Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                        <select id="streamerSelect" class="w-full bg-input border border-border rounded-lg px-4 py-3 text-foreground focus:outline-none focus:ring-2 focus:ring-ring">
                            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø°ÙŠØ¹...</option>
                        </select>
                    </div>

                    <!-- Best Of -->
                    <div>
                        <label class="block text-sm font-medium text-foreground mb-2">Ø£ÙØ¶Ù„ Ù…Ù†</label>
                        <select id="bestOf" class="w-full bg-input border border-border rounded-lg px-4 py-3 text-foreground focus:outline-none focus:ring-2 focus:ring-ring">
                            <option value="1">Ù…Ø¨Ø§Ø±Ø§Ø© ÙˆØ§Ø­Ø¯Ø©</option>
                            <option value="3">Ø£ÙØ¶Ù„ Ù…Ù† 3</option>
                            <option value="5">Ø£ÙØ¶Ù„ Ù…Ù† 5</option>
                            <option value="7">Ø£ÙØ¶Ù„ Ù…Ù† 7</option>
                        </select>
                    </div>

                    <!-- Scheduled Date -->
                    <div class="lg:col-span-2">
                        <label class="block text-sm font-medium text-foreground mb-2">Ù…ÙˆØ¹Ø¯ Ø§Ù„Ø­Ø±Ø¨</label>
                        <input 
                            type="datetime-local" 
                            id="scheduledAt"
                            class="w-full bg-input border border-border rounded-lg px-4 py-3 text-foreground focus:outline-none focus:ring-2 focus:ring-ring"
                        >
                    </div>
                </div>
            </div>

            <!-- Step 3: Challenge Message -->
            <div class="military-card p-6">
                <h3 class="text-lg font-semibold text-foreground mb-4">3. Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠ</h3>
                
                <textarea 
                    id="challengeMessage"
                    rows="4"
                    placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© ØªØ­Ø¯ÙŠ Ù…Ø«ÙŠØ±Ø© Ù„Ù„Ø¹Ø´ÙŠØ±Ø© Ø§Ù„Ù…Ù†Ø§ÙØ³Ø©..."
                    class="w-full bg-input border border-border rounded-lg px-4 py-3 text-foreground placeholder-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring resize-none"
                ></textarea>
                
                <div class="mt-4">
                    <label class="block text-sm font-medium text-foreground mb-2">Ù‚ÙˆØ§Ù†ÙŠÙ† Ø¥Ø¶Ø§ÙÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                    <textarea 
                        id="rulesText"
                        rows="3"
                        placeholder="Ø£ÙŠ Ù‚ÙˆØ§Ù†ÙŠÙ† Ø£Ùˆ Ø´Ø±ÙˆØ· Ø®Ø§ØµØ© Ù„Ù„Ø­Ø±Ø¨..."
                        class="w-full bg-input border border-border rounded-lg px-4 py-3 text-foreground placeholder-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring resize-none"
                    ></textarea>
                </div>
            </div>

            <!-- Submit Button -->
            <div class="flex justify-end gap-4">
                <button 
                    type="button"
                    onclick="window.history.back()"
                    class="btn btn-outline"
                >
                    Ø¥Ù„ØºØ§Ø¡
                </button>
                <button 
                    id="declareWarBtn"
                    onclick="declareWar()"
                    class="btn btn-primary bg-alert-red hover:bg-alert-red/90"
                >
                    ğŸ”¥ Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ø­Ø±Ø¨
                </button>
            </div>
        </div>
    </div>

        <!-- Loading Modal -->
        <div id="loadingModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden">
            <div class="military-card p-8 max-w-sm w-full mx-4">
                <div class="text-center">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-tactical-green mx-auto mb-4"></div>
                    <h3 class="text-lg font-semibold text-foreground mb-2">Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ­Ø¯ÙŠ...</h3>
                    <p class="text-muted-foreground">ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</p>
                </div>
            </div>
        </div>

        <!-- Success Modal -->
        <div id="successModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden">
            <div class="military-card p-8 max-w-md w-full mx-4">
                <div class="text-center">
                    <div class="w-16 h-16 bg-tactical-green rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                    </div>
                    <h3 class="text-lg font-semibold text-foreground mb-2">ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ­Ø¯ÙŠ!</h3>
                    <p class="text-muted-foreground mb-6" id="successMessage"></p>
                    <button 
                        onclick="closeModal('successModal')"
                        class="btn btn-primary"
                    >
                        Ø­Ø³Ù†Ø§Ù‹
                    </button>
                </div>
            </div>
        </div>
</BaseLayout>

<script>
// Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø©
let warData = null;
let selectedClanId = null;

// Ø¯ÙˆØ§Ù„ Ø¹Ø§Ù…Ø© Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„ÙŠÙ‡Ø§ Ù…Ù† HTML
window.selectClan = function(id, name, tag, level, points) {
    selectedClanId = id;
    
    document.getElementById('selectedClanTag').textContent = tag;
    document.getElementById('selectedClanName').textContent = name;
    document.getElementById('selectedClanLevel').textContent = level;
    document.getElementById('selectedClanPoints').textContent = points;
    
    document.getElementById('selectedClan').classList.remove('hidden');
    document.getElementById('clanSearchResults').classList.add('hidden');
    document.getElementById('clanSearch').value = '';
};

window.clearSelectedClan = function() {
    selectedClanId = null;
    document.getElementById('selectedClan').classList.add('hidden');
};

window.declareWar = async function() {
    if (!selectedClanId) {
        alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø¹Ø´ÙŠØ±Ø© Ù„Ù„ØªØ­Ø¯ÙŠ');
        return;
    }
    
    // Ø¨Ø§Ù‚ÙŠ ÙƒÙˆØ¯ Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ø­Ø±Ø¨...
    const token = localStorage.getItem('zh_love_token');
    const warTypeId = document.getElementById('warTypeSelect').value;
    const mapId = document.getElementById('mapSelect').value;
    const streamerId = document.getElementById('streamerSelect').value;
    const bestOf = document.getElementById('bestOf').value;
    const scheduledAt = document.getElementById('scheduledAt').value;
    const challengeMessage = document.getElementById('challengeMessage').value;
    const rulesText = document.getElementById('rulesText').value;
    
    if (!warTypeId || !scheduledAt || !challengeMessage) {
        alert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©');
        return;
    }
    
    try {
        const response = await fetch('http://localhost:8080/war_api.php?action=declare_war', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                challenged_clan_id: selectedClanId,
                war_type_id: warTypeId,
                map_id: mapId,
                streamer_id: streamerId,
                best_of: bestOf,
                scheduled_at: scheduledAt,
                challenge_message: challengeMessage,
                rules: rulesText
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showModal('successModal');
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
            clearSelectedClan();
            document.getElementById('declareWarForm').reset();
        } else {
            alert('Ø®Ø·Ø£: ' + (data.error || 'ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ­Ø¯ÙŠ'));
        }
    } catch (error) {
        alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…');
        console.error(error);
    }
};

// Load initial data
async function loadWarData() {
    try {
        const token = localStorage.getItem('zh_love_token');
        if (!token) {
            window.location.href = '/ar/login';
            return;
        }

        const response = await fetch('http://localhost:8080/war_api.php?action=get_war_data', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        const data = await response.json();
        if (data.success) {
            warData = data;
            populateSelects();
        } else {
            alert('ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø±Ø¨: ' + (data.error || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
        }
    } catch (error) {
        console.error('Error loading war data:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
    }
}

function populateSelects() {
    // Populate war types
    const warTypeSelect = document.getElementById('warType');
    warData.war_types.forEach(type => {
        const option = document.createElement('option');
        option.value = type.id;
        option.textContent = type.name;
        warTypeSelect.appendChild(option);
    });

    // Populate maps
    const mapSelect = document.getElementById('mapSelect');
    warData.maps.forEach(map => {
        const option = document.createElement('option');
        option.value = map.id;
        option.textContent = map.name;
        mapSelect.appendChild(option);
    });

    // Populate streamers
    const streamerSelect = document.getElementById('streamerSelect');
    warData.streamers.forEach(streamer => {
        const option = document.createElement('option');
        option.value = streamer.id;
        option.textContent = streamer.channel_name;
        streamerSelect.appendChild(option);
    });
}

// Clan search functionality
let searchTimeout;
document.getElementById('clanSearch').addEventListener('input', function() {
    clearTimeout(searchTimeout);
    const searchTerm = this.value.trim();
    
    if (searchTerm.length < 2) {
        document.getElementById('clanSearchResults').classList.add('hidden');
        return;
    }
    
    searchTimeout = setTimeout(() => searchClans(searchTerm), 300);
});

async function searchClans(searchTerm) {
    try {
        const token = localStorage.getItem('zh_love_token');
        const response = await fetch(`http://localhost:8080/war_api.php?action=search_clans&search=${encodeURIComponent(searchTerm)}`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        const data = await response.json();
        if (data.success) {
            displaySearchResults(data.clans);
        }
    } catch (error) {
        console.error('Error searching clans:', error);
    }
}

function displaySearchResults(clans) {
    const resultsContainer = document.getElementById('clanSearchResults');
    
    if (clans.length === 0) {
        resultsContainer.innerHTML = '<div class="p-4 text-muted-foreground text-center">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ø´Ø§Ø¦Ø±</div>';
        resultsContainer.classList.remove('hidden');
        return;
    }
    
    resultsContainer.innerHTML = clans.map(clan => `
        <div class="p-4 hover:bg-muted cursor-pointer border-b border-border last:border-b-0" onclick="selectClan(${clan.id}, '${clan.name}', '${clan.tag}', ${clan.level}, ${clan.total_points})">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-gradient-to-r from-alert-red to-tactical-orange rounded-lg flex items-center justify-center">
                    <span class="text-white font-bold text-sm">${clan.tag}</span>
                </div>
                <div>
                    <h4 class="text-foreground font-medium">${clan.name}</h4>
                    <p class="text-muted-foreground text-sm">Ø§Ù„Ù…Ø³ØªÙˆÙ‰: ${clan.level} | Ø§Ù„Ù†Ù‚Ø§Ø·: ${clan.total_points} | Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡: ${clan.member_count}</p>
                </div>
            </div>
        </div>
    `).join('');
    
    resultsContainer.classList.remove('hidden');
}

// Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©
function showModal(modalId) {
    document.getElementById(modalId).classList.remove('hidden');
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.add('hidden');
}

// Set minimum date to current date
document.addEventListener('DOMContentLoaded', function() {
    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    document.getElementById('scheduledAt').min = now.toISOString().slice(0, 16);
    
    loadWarData();
});

// Hide search results when clicking outside
document.addEventListener('click', function(e) {
    if (!e.target.closest('#clanSearch') && !e.target.closest('#clanSearchResults')) {
        document.getElementById('clanSearchResults').classList.add('hidden');
    }
});
</script>

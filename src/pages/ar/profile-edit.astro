---
import BaseLayout from '../../../layouts/BaseLayout.astro';

const title = "الملف الشخصي - زد اتش لوف";
const description = "تحرير ملفك الشخصي ومعلوماتك";
---

<BaseLayout title={title} description={description}>
  <main class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="bg-gradient-to-r from-green-500/10 to-blue-500/10 rounded-xl p-8 mb-8">
      <div class="flex items-center gap-4 mb-4">
        <div class="w-16 h-16 bg-gradient-to-r from-green-600 to-green-700 rounded-full flex items-center justify-center">
          <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
          </svg>
        </div>
        <div>
          <h1 class="text-3xl font-bold text-gray-100">الملف الشخصي</h1>
          <p class="text-gray-300">إدارة معلوماتك الشخصية</p>
        </div>
      </div>
    </div>

    <!-- Profile Form -->
    <div class="bg-gray-800 border border-gray-700 rounded-lg p-6 mb-6">
      <h2 class="text-xl font-semibold text-gray-100 mb-6 flex items-center gap-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
        </svg>
        تحرير المعلومات الشخصية
      </h2>
      
      <form id="profileForm" class="space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Avatar Section -->
          <div class="md:col-span-2 text-center">
            <div id="currentAvatar" class="w-24 h-24 bg-gradient-to-r from-green-600 to-green-700 rounded-full flex items-center justify-center mx-auto mb-4">
              <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
              </svg>
            </div>
            <button type="button" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors text-sm">
              تغيير الصورة الشخصية
            </button>
          </div>
          
          <!-- Username -->
          <div>
            <label for="username" class="block text-sm font-medium text-gray-300 mb-2">
              اسم المستخدم *
            </label>
            <input
              type="text"
              id="username"
              required
              class="w-full px-3 py-2 border border-gray-600 rounded-md bg-gray-700 text-gray-100 focus:ring-2 focus:ring-green-500 focus:border-transparent"
              placeholder="اسم المستخدم"
            />
          </div>
          
          <!-- Email -->
          <div>
            <label for="email" class="block text-sm font-medium text-gray-300 mb-2">
              البريد الإلكتروني *
            </label>
            <input
              type="email"
              id="email"
              required
              class="w-full px-3 py-2 border border-gray-600 rounded-md bg-gray-700 text-gray-100 focus:ring-2 focus:ring-green-500 focus:border-transparent"
              placeholder="user@example.com"
            />
          </div>
          
          <!-- First Name -->
          <div>
            <label for="firstName" class="block text-sm font-medium text-gray-300 mb-2">
              الاسم الأول
            </label>
            <input
              type="text"
              id="firstName"
              class="w-full px-3 py-2 border border-gray-600 rounded-md bg-gray-700 text-gray-100 focus:ring-2 focus:ring-green-500 focus:border-transparent"
              placeholder="الاسم الأول"
            />
          </div>
          
          <!-- Last Name -->
          <div>
            <label for="lastName" class="block text-sm font-medium text-gray-300 mb-2">
              اسم العائلة
            </label>
            <input
              type="text"
              id="lastName"
              class="w-full px-3 py-2 border border-gray-600 rounded-md bg-gray-700 text-gray-100 focus:ring-2 focus:ring-green-500 focus:border-transparent"
              placeholder="اسم العائلة"
            />
          </div>
          
          <!-- Country -->
          <div>
            <label for="country" class="block text-sm font-medium text-gray-300 mb-2">
              البلد
            </label>
            <select
              id="country"
              class="w-full px-3 py-2 border border-gray-600 rounded-md bg-gray-700 text-gray-100 focus:ring-2 focus:ring-green-500 focus:border-transparent"
            >
              <option value="">اختر البلد</option>
              <option value="مصر">مصر</option>
              <option value="السعودية">السعودية</option>
              <option value="الإمارات">الإمارات</option>
              <option value="الكويت">الكويت</option>
              <option value="قطر">قطر</option>
              <option value="البحرين">البحرين</option>
              <option value="الأردن">الأردن</option>
              <option value="لبنان">لبنان</option>
              <option value="سوريا">سوريا</option>
              <option value="العراق">العراق</option>
              <option value="المغرب">المغرب</option>
              <option value="الجزائر">الجزائر</option>
              <option value="تونس">تونس</option>
              <option value="ليبيا">ليبيا</option>
              <option value="السودان">السودان</option>
            </select>
          </div>
          
          <!-- Join Date (Read Only) -->
          <div>
            <label for="joinDate" class="block text-sm font-medium text-gray-300 mb-2">
              تاريخ الانضمام
            </label>
            <input
              type="text"
              id="joinDate"
              readonly
              class="w-full px-3 py-2 border border-gray-600 rounded-md bg-gray-600 text-gray-300 cursor-not-allowed"
              placeholder="تاريخ الانضمام"
            />
          </div>
        </div>
        
        <!-- Bio -->
        <div>
          <label for="bio" class="block text-sm font-medium text-gray-300 mb-2">
            نبذة عنك
          </label>
          <textarea
            id="bio"
            rows="4"
            class="w-full px-3 py-2 border border-gray-600 rounded-md bg-gray-700 text-gray-100 focus:ring-2 focus:ring-green-500 focus:border-transparent resize-none"
            placeholder="اكتب نبذة مختصرة عنك..."
          ></textarea>
          <p class="text-xs text-gray-400 mt-1">أقصى حد 500 حرف</p>
        </div>
        
        <!-- Action Buttons -->
        <div class="flex gap-4 pt-4">
          <button
            type="submit"
            id="saveButton"
            class="bg-green-600 text-white px-6 py-2 rounded-md hover:bg-green-700 transition-colors flex items-center gap-2"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            حفظ التغييرات
          </button>
          
          <button
            type="button"
            id="cancelButton"
            class="bg-gray-600 text-white px-6 py-2 rounded-md hover:bg-gray-700 transition-colors"
          >
            إلغاء
          </button>
        </div>
      </form>
      
      <!-- Loading State -->
      <div id="loadingState" class="hidden text-center p-8">
        <div class="animate-spin w-8 h-8 border-2 border-green-500 border-t-transparent rounded-full mx-auto mb-4"></div>
        <p class="text-gray-300">جاري تحميل البيانات...</p>
      </div>
    </div>

    <!-- Account Stats -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <div class="bg-gray-800 border border-gray-700 rounded-lg p-6 text-center">
        <div class="text-2xl font-bold text-green-500 mb-2" id="postCount">0</div>
        <div class="text-gray-300">المنشورات</div>
      </div>
      
      <div class="bg-gray-800 border border-gray-700 rounded-lg p-6 text-center">
        <div class="text-2xl font-bold text-blue-500 mb-2" id="commentCount">0</div>
        <div class="text-gray-300">التعليقات</div>
      </div>
      
      <div class="bg-gray-800 border border-gray-700 rounded-lg p-6 text-center">
        <div class="text-2xl font-bold text-yellow-500 mb-2" id="likeCount">0</div>
        <div class="text-gray-300">الإعجابات</div>
      </div>
    </div>

    <!-- Navigation -->
    <div class="bg-gray-800 border border-gray-700 rounded-lg p-6 mt-6">
      <h3 class="text-lg font-semibold text-gray-100 mb-4">التنقل</h3>
      <div class="flex gap-4">
        <a href="/ar/profile" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">
          عرض الملف الشخصي
        </a>
        <button
          onclick="logout()"
          class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition-colors"
        >
          تسجيل الخروج
        </button>
      </div>
    </div>
  </main>
</BaseLayout>

<script>
  let currentUser = null;
  
  // Logout function
  window.logout = function() {
    if (confirm('هل أنت متأكد من تسجيل الخروج؟')) {
      localStorage.removeItem('authToken');
      localStorage.removeItem('currentUser');
      window.location.href = '/ar/login';
    }
  };
  
  // Load user data
  async function loadUserData() {
    const form = document.getElementById('profileForm');
    const loadingState = document.getElementById('loadingState');
    
    try {
      // Show loading
      form.style.display = 'none';
      loadingState.classList.remove('hidden');
      
      const token = localStorage.getItem('authToken');
      
      if (!token) {
        // No token, redirect to login
        window.location.href = '/ar/login';
        return;
      }
      
      const response = await fetch('http://localhost:8000/forum_api.php?action=get_user_info', {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const data = await response.json();
      
      if (data.error) {
        // Token invalid, redirect to login
        localStorage.removeItem('authToken');
        localStorage.removeItem('currentUser');
        window.location.href = '/ar/login';
        return;
      }
      
      currentUser = data.user;
      populateForm(currentUser);
      
      // Show form
      loadingState.classList.add('hidden');
      form.style.display = 'block';
      
    } catch (error) {
      console.error('Error loading user data:', error);
      
      // Error loading user, redirect to login
      localStorage.removeItem('authToken');
      localStorage.removeItem('currentUser');
      window.location.href = '/ar/login';
    }
  }
  
  // Populate form with user data
  function populateForm(user) {
    document.getElementById('username').value = user.username || '';
    document.getElementById('email').value = user.email || '';
    document.getElementById('firstName').value = user.first_name || '';
    document.getElementById('lastName').value = user.last_name || '';
    document.getElementById('bio').value = user.bio || '';
    document.getElementById('country').value = user.country || '';
    document.getElementById('joinDate').value = user.join_date || 'غير محدد';
    
    // Update stats (real data from API)
    document.getElementById('postCount').textContent = user.post_count || 0;
    document.getElementById('commentCount').textContent = user.comment_count || 0;
    document.getElementById('likeCount').textContent = user.like_count || 0;
  }
  
  // Save profile
  async function saveProfile(formData) {
    const saveButton = document.getElementById('saveButton');
    const originalText = saveButton.innerHTML;
    
    try {
      // Show loading on button
      saveButton.innerHTML = `
        <svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
        </svg>
        جاري الحفظ...
      `;
      saveButton.disabled = true;
      
      const token = localStorage.getItem('authToken');
      
      const response = await fetch('http://localhost:8000/forum_api.php?action=update_profile', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(formData)
      });
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const data = await response.json();
      
      if (data.error) {
        throw new Error(data.error);
      }
      
      // Success
      alert('تم حفظ التغييرات بنجاح!');
      currentUser = data.user;
      
    } catch (error) {
      console.error('Error saving profile:', error);
      alert('حدث خطأ أثناء حفظ التغييرات: ' + error.message);
    } finally {
      // Restore button
      saveButton.innerHTML = originalText;
      saveButton.disabled = false;
    }
  }
  
  // Form submission
  document.getElementById('profileForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = {
      username: document.getElementById('username').value.trim(),
      email: document.getElementById('email').value.trim(),
      first_name: document.getElementById('firstName').value.trim(),
      last_name: document.getElementById('lastName').value.trim(),
      bio: document.getElementById('bio').value.trim(),
      country: document.getElementById('country').value
    };
    
    // Validate
    if (!formData.username) {
      alert('اسم المستخدم مطلوب');
      return;
    }
    
    if (!formData.email) {
      alert('البريد الإلكتروني مطلوب');
      return;
    }
    
    if (formData.bio.length > 500) {
      alert('النبذة الشخصية لا يمكن أن تزيد عن 500 حرف');
      return;
    }
    
    await saveProfile(formData);
  });
  
  // Cancel button
  document.getElementById('cancelButton').addEventListener('click', () => {
    if (currentUser) {
      populateForm(currentUser);
    }
  });
  
  // Character counter for bio
  document.getElementById('bio').addEventListener('input', (e) => {
    const length = e.target.value.length;
    const counter = e.target.nextElementSibling;
    counter.textContent = `${length}/500 حرف`;
    
    if (length > 500) {
      counter.classList.add('text-red-400');
      counter.classList.remove('text-gray-400');
    } else {
      counter.classList.remove('text-red-400');
      counter.classList.add('text-gray-400');
    }
  });
  
  // Load data when page loads
  document.addEventListener('DOMContentLoaded', loadUserData);
</script>
